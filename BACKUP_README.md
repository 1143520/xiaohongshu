# 大红薯图文社区 - 数据备份与恢复说明

## 📦 备份脚本 (backup.sh)

### 功能说明

- 自动备份数据库（完整备份，包含表结构和数据）
- 备份重要配置文件（.env, docker-compose.yml 等）
- 自动压缩备份文件
- 自动清理 7 天前的旧备份
- 支持本地 MySQL 和 Docker 容器内 MySQL

### 使用方法

```bash
# 给脚本执行权限
chmod +x backup.sh

# 执行备份
./backup.sh
```

### 备份内容

- `database.sql` - 完整数据库备份
- `env.backup` - 环境配置文件
- `docker-compose.yml` - Docker 编排配置
- `docker-compose.prod.yml` - 生产环境配置
- `backup_info.txt` - 备份信息和表列表

### 备份存储

- 备份文件存储在 `./backups/` 目录
- 文件名格式：`xiaoshiliu_backup_YYYYMMDD_HHMMSS.tar.gz`
- 自动清理 7 天前的备份文件

---

## 🔄 恢复脚本 (restore.sh)

### 功能说明

- 从备份文件恢复数据库
- 可选择性恢复配置文件
- 恢复前可备份当前数据
- 支持本地 MySQL 和 Docker 容器内 MySQL
- 自动重启 Docker 服务

### 使用方法

```bash
# 给脚本执行权限
chmod +x restore.sh

# 执行恢复（需要指定备份文件）
./restore.sh ./backups/xiaoshiliu_backup_20241201_143022.tar.gz
```

### 恢复流程

1. 解压备份文件
2. 检查数据库连接
3. 可选：备份当前数据库
4. 恢复数据库数据
5. 可选：恢复配置文件
6. 可选：重启 Docker 服务

---

## 🛠️ 环境要求

### 系统要求

- Linux/Unix 系统
- Bash shell 4.0+

### 数据库要求

以下任一种：

- 本地安装的 MySQL 客户端 (`mysql`, `mysqldump`)
- 运行中的 Docker 容器 `xiaoshiliu-mysql`

### 权限要求

- 数据库读写权限
- 文件系统读写权限
- Docker 操作权限（如使用 Docker）

---

## ⚠️ 注意事项

### 备份注意事项

1. 确保数据库连接正常
2. 确保有足够的磁盘空间
3. 生产环境建议在低峰期执行备份
4. 定期测试备份文件的完整性

### 恢复注意事项

1. **恢复操作会覆盖现有数据**
2. 强烈建议恢复前备份当前数据
3. 确认数据库配置正确
4. 恢复后验证数据完整性
5. 必要时重启应用服务

### 安全建议

1. 备份文件包含敏感信息，注意安全存储
2. 定期清理不需要的备份文件
3. 在生产环境中，建议将备份存储到远程位置
4. 配置文件中的密码等敏感信息需谨慎处理

---

## 📅 最佳实践

### 备份策略

- **每日备份**：设置定时任务，每天自动备份
- **重要操作前备份**：部署、更新前手动备份
- **异地备份**：将重要备份文件上传到云存储

### 定时备份设置

```bash
# 编辑crontab
crontab -e

# 添加每天凌晨2点自动备份
0 2 * * * /path/to/xiaoshiliu/backup.sh
```

### 监控备份

- 检查备份文件大小是否合理
- 验证备份文件可以正常解压
- 定期测试恢复流程

---

## 🚨 故障排除

### 常见问题

**1. 数据库连接失败**

- 检查数据库服务是否运行
- 检查用户名密码是否正确
- 检查网络连接

**2. 权限不足**

- 确保脚本有执行权限：`chmod +x *.sh`
- 确保用户有数据库操作权限
- 确保有文件读写权限

**3. 磁盘空间不足**

- 清理旧备份文件
- 检查可用磁盘空间
- 考虑压缩备份文件

**4. Docker 容器问题**

- 确保容器名称正确（`xiaoshiliu-mysql`）
- 检查容器是否运行：`docker ps`
- 检查容器日志：`docker logs xiaoshiliu-mysql`

---

## 📞 技术支持

如遇到问题，请检查：

1. 脚本执行日志
2. 数据库错误日志
3. Docker 容器状态
4. 系统资源使用情况

记录详细的错误信息以便排查问题。
